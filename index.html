<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParkinPT - Sistema de Monitoreo de Riesgo Prodrómico de Parkinson</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ... (todos los estilos anteriores se mantienen igual) ... */
        
        /* Nuevos estilos para opciones "Ninguno" */
        .none-option {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .none-option.selected {
            background: #e8f5e8;
            border-color: #27ae60;
        }
        
        .checkbox-group.with-none {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .none-checkbox {
            width: 100%;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ... (todo el HTML anterior se mantiene igual hasta la sección de medicamentos) ... -->
        
        <!-- Profile Tab -->
        <div id="profile" class="tab-content active">
            <h2>Mi Perfil Médico</h2>
            <p>Complete su información médica para una evaluación más precisa</p>
            
            <div class="profile-completion" id="profile-completion-status">
                <h3><i class="fas fa-clipboard-check"></i> Estado del Perfil</h3>
                <p>Complete los campos obligatorios para obtener una evaluación precisa.</p>
                <div id="completion-progress"></div>
            </div>
            
            <div class="profile-form">
                <h3><i class="fas fa-user-circle"></i> Información Personal</h3>
                <div class="form-group">
                    <label for="profile-name">Nombre o Identificador:</label>
                    <input type="text" id="profile-name" class="form-control" placeholder="Ej: Juan Pérez" required>
                    <div class="field-error" id="name-error"></div>
                </div>
                <div class="form-group">
                    <label for="profile-birthdate">Fecha de Nacimiento:</label>
                    <input type="date" id="profile-birthdate" class="form-control" required>
                    <div class="field-error" id="birthdate-error"></div>
                </div>
                <div class="form-group">
                    <label for="profile-sex">Sexo:</label>
                    <select id="profile-sex" class="form-control" required>
                        <option value="">Seleccionar...</option>
                        <option value="male">Masculino</option>
                        <option value="female">Femenino</option>
                    </select>
                    <div class="field-error" id="sex-error"></div>
                </div>
                
                <h3 style="margin-top: 30px;"><i class="fas fa-stethoscope"></i> Antecedentes Médicos</h3>
                <div class="form-group">
                    <label for="profile-family-history">Antecedentes familiares de Parkinson:</label>
                    <select id="profile-family-history" class="form-control" required>
                        <option value="">Seleccionar...</option>
                        <option value="yes">Sí</option>
                        <option value="no">No</option>
                        <option value="unknown">No estoy seguro</option>
                    </select>
                    <div class="field-error" id="family-history-error"></div>
                </div>
                
                <!-- SECCIÓN MODIFICADA: Medicamentos -->
                <div class="medication-section">
                    <h4><i class="fas fa-pills"></i> Medicamentos Actuales</h4>
                    <p>Seleccione los medicamentos que toma regularmente:</p>
                    
                    <!-- Opción "No tomo medicamentos" -->
                    <div class="none-option" id="no-medications-option">
                        <div class="checkbox-item none-checkbox">
                            <input type="checkbox" id="no-medications" name="no-medications">
                            <label for="no-medications"><strong>No tomo ningún medicamento regularmente</strong></label>
                        </div>
                    </div>
                    
                    <div class="checkbox-group with-none" id="medication-checkboxes">
                        <!-- Los medicamentos se cargarán dinámicamente -->
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="other-medications">Otros medicamentos (especifique):</label>
                        <input type="text" id="other-medications" class="form-control" placeholder="Ej: Omeprazol, Atorvastatina...">
                    </div>
                </div>
                
                <!-- SECCIÓN MODIFICADA: Condiciones Médicas -->
                <div class="condition-section">
                    <h4><i class="fas fa-file-medical"></i> Condiciones Médicas</h4>
                    <p>Seleccione las condiciones médicas que le han diagnosticado:</p>
                    
                    <!-- Opción "No tengo condiciones médicas" -->
                    <div class="none-option" id="no-conditions-option">
                        <div class="checkbox-item none-checkbox">
                            <input type="checkbox" id="no-conditions" name="no-conditions">
                            <label for="no-conditions"><strong>No tengo condiciones médicas diagnosticadas</strong></label>
                        </div>
                    </div>
                    
                    <div class="checkbox-group with-none" id="condition-checkboxes">
                        <!-- Las condiciones se cargarán dinámicamente -->
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="other-conditions">Otras condiciones (especifique):</label>
                        <input type="text" id="other-conditions" class="form-control" placeholder="Ej: Migraña, Artritis...">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="profile-notes">Notas Médicas Adicionales:</label>
                    <textarea id="profile-notes" class="form-control" rows="4" placeholder="Puede agregar información relevante sobre su salud, cirugías previas, alergias..."></textarea>
                </div>
                
                <button class="btn btn-success" id="save-profile-btn">
                    <i class="fas fa-save"></i> Guardar Perfil
                </button>
            </div>
            
            <!-- ... (el resto del HTML se mantiene igual) ... -->
        </div>
        
        <!-- ... (el resto del HTML se mantiene igual) ... -->
    </div>

    <script>
        // =============================================
        // DATOS CIENTÍFICOS ACTUALIZADOS CON EVIDENCIA
        // =============================================

        // ... (todos los datos científicos anteriores se mantienen igual) ...

        // =============================================
        // ESTADO DE LA APLICACIÓN
        // =============================================

        let currentSession = {
            id: generateSessionId(),
            date: new Date().toISOString(),
            symptoms: {},
            results: null,
            clinicalAdjustmentDetails: []
        };

        let userProfile = {
            name: "Usuario Anónimo",
            birthdate: "",
            sex: "",
            familyHistory: "",
            medications: [],
            conditions: [],
            otherMedications: "",
            otherConditions: "",
            notes: "",
            noMedications: false,  // NUEVO: indicador de "no medicamentos"
            noConditions: false     // NUEVO: indicador de "no condiciones"
        };

        // =============================================
        // FUNCIONES PRINCIPALES MODIFICADAS
        // =============================================

        // ... (las funciones anteriores se mantienen igual hasta validateProfileData) ...

        function validateProfileData() {
            const errors = [];
            
            if (userProfile.birthdate) {
                const birthdate = new Date(userProfile.birthdate);
                const today = new Date();
                if (birthdate > today) {
                    errors.push("La fecha de nacimiento no puede ser futura");
                }
                const age = calculateAge(userProfile.birthdate);
                if (age > 120) {
                    errors.push("Por favor verifique la fecha de nacimiento");
                }
                if (age < 18) {
                    errors.push("Debe ser mayor de 18 años para usar esta herramienta");
                }
            } else {
                errors.push("La fecha de nacimiento es obligatoria");
            }
            
            // MODIFICADO: Ya no es obligatorio seleccionar medicamentos o condiciones
            // El usuario puede indicar explícitamente que no toma medicamentos o no tiene condiciones
            
            return errors;
        }

        // ... (las funciones anteriores se mantienen igual hasta generateMedicalCheckboxes) ...

        function generateMedicalCheckboxes() {
            const medContainer = document.getElementById('medication-checkboxes');
            medContainer.innerHTML = '';
            
            medicationsData.forEach(med => {
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'checkbox-item';
                checkboxItem.innerHTML = `
                    <input type="checkbox" id="med-${med.id}" value="${med.id}" class="medication-checkbox">
                    <label for="med-${med.id}">${med.name}</label>
                `;
                medContainer.appendChild(checkboxItem);
            });
            
            const condContainer = document.getElementById('condition-checkboxes');
            condContainer.innerHTML = '';
            
            conditionsData.forEach(cond => {
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'checkbox-item';
                checkboxItem.innerHTML = `
                    <input type="checkbox" id="cond-${cond.id}" value="${cond.id}" class="condition-checkbox">
                    <label for="cond-${cond.id}">${cond.name}</label>
                `;
                condContainer.appendChild(checkboxItem);
            });
            
            // NUEVO: Agregar event listeners para las opciones "Ninguno"
            setupNoneOptions();
        }

        // NUEVA FUNCIÓN: Configurar el comportamiento de las opciones "Ninguno"
        function setupNoneOptions() {
            const noMedsCheckbox = document.getElementById('no-medications');
            const noConditionsCheckbox = document.getElementById('no-conditions');
            const medCheckboxes = document.querySelectorAll('.medication-checkbox');
            const conditionCheckboxes = document.querySelectorAll('.condition-checkbox');
            
            // Comportamiento para "No tomo medicamentos"
            noMedsCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    // Desmarcar todos los medicamentos
                    medCheckboxes.forEach(cb => {
                        cb.checked = false;
                        cb.disabled = true;
                    });
                    document.getElementById('other-medications').disabled = true;
                    document.getElementById('no-medications-option').classList.add('selected');
                } else {
                    // Habilitar todos los medicamentos
                    medCheckboxes.forEach(cb => {
                        cb.disabled = false;
                    });
                    document.getElementById('other-medications').disabled = false;
                    document.getElementById('no-medications-option').classList.remove('selected');
                }
            });
            
            // Comportamiento para "No tengo condiciones"
            noConditionsCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    // Desmarcar todas las condiciones
                    conditionCheckboxes.forEach(cb => {
                        cb.checked = false;
                        cb.disabled = true;
                    });
                    document.getElementById('other-conditions').disabled = true;
                    document.getElementById('no-conditions-option').classList.add('selected');
                } else {
                    // Habilitar todas las condiciones
                    conditionCheckboxes.forEach(cb => {
                        cb.disabled = false;
                    });
                    document.getElementById('other-conditions').disabled = false;
                    document.getElementById('no-conditions-option').classList.remove('selected');
                }
            });
            
            // Si se selecciona algún medicamento, desmarcar "No tomo medicamentos"
            medCheckboxes.forEach(cb => {
                cb.addEventListener('change', function() {
                    if (this.checked) {
                        noMedsCheckbox.checked = false;
                        noMedsCheckbox.dispatchEvent(new Event('change'));
                    }
                });
            });
            
            // Si se selecciona alguna condición, desmarcar "No tengo condiciones"
            conditionCheckboxes.forEach(cb => {
                cb.addEventListener('change', function() {
                    if (this.checked) {
                        noConditionsCheckbox.checked = false;
                        noConditionsCheckbox.dispatchEvent(new Event('change'));
                    }
                });
            });
        }

        function updateProfileCompletion() {
            const completionElement = document.getElementById('completion-progress');
            let completedFields = 0;
            const totalFields = 4; // MODIFICADO: Ahora son 4 campos obligatorios
            
            if (userProfile.name && userProfile.name !== "Usuario Anónimo") completedFields++;
            if (userProfile.birthdate) completedFields++;
            if (userProfile.sex) completedFields++;
            if (userProfile.familyHistory) completedFields++;
            // MODIFICADO: Ya no se requiere medicamentos o condiciones
            
            const percentage = Math.round((completedFields / totalFields) * 100);
            
            let statusText, statusColor;
            if (percentage < 50) {
                statusText = "Perfil Incompleto";
                statusColor = "#e74c3c";
            } else if (percentage < 100) {
                statusText = "Perfil Parcialmente Completo";
                statusColor = "#f39c12";
            } else {
                statusText = "Perfil Completo";
                statusColor = "#27ae60";
            }
            
            completionElement.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                    <div style="flex: 1; background: #ecf0f1; border-radius: 10px; height: 20px; overflow: hidden;">
                        <div style="height: 100%; background: ${statusColor}; width: ${percentage}%; transition: width 0.5s;"></div>
                    </div>
                    <div style="font-weight: bold; color: ${statusColor}">${percentage}% - ${statusText}</div>
                </div>
                <p style="margin-top: 10px; font-size: 0.9em;">${completedFields} de ${totalFields} campos obligatorios completados</p>
            `;
            
            return percentage;
        }

        // =============================================
        // INICIALIZACIÓN DE LA APLICACIÓN MODIFICADA
        // =============================================

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            document.getElementById('start-evaluation-btn').addEventListener('click', function() {
                const completion = updateProfileCompletion();
                if (completion < 50) {
                    alert('Por favor, complete al menos el 50% de su perfil médico antes de realizar la evaluación.');
                    switchTab('profile');
                    return;
                }
                switchTab('evaluation');
            });

            document.getElementById('new-session-btn').addEventListener('click', newSession);
            document.getElementById('save-session-btn').addEventListener('click', saveSession);
            document.getElementById('calculate-risk-btn').addEventListener('click', calculateEnhancedRisk);
            document.getElementById('save-profile-btn').addEventListener('click', saveProfile);
            document.getElementById('export-data-btn').addEventListener('click', exportData);
            document.getElementById('clear-data-btn').addEventListener('click', clearData);

            loadUserProfile();
            loadSessions();
            updateSessionDisplay();
            generateMedicalCheckboxes();
            generateEvaluationInterface();
            updateProfileCompletion();
            setupRealTimeValidation();
            switchTab('profile');
        });

        // ... (las funciones anteriores se mantienen igual hasta saveProfile) ...

        function saveProfile() {
            userProfile.name = document.getElementById('profile-name').value || 'Usuario Anónimo';
            userProfile.birthdate = document.getElementById('profile-birthdate').value;
            userProfile.sex = document.getElementById('profile-sex').value;
            userProfile.familyHistory = document.getElementById('profile-family-history').value;
            userProfile.otherMedications = document.getElementById('other-medications').value;
            userProfile.otherConditions = document.getElementById('other-conditions').value;
            userProfile.notes = document.getElementById('profile-notes').value;
            
            // NUEVO: Capturar las opciones "Ninguno"
            userProfile.noMedications = document.getElementById('no-medications').checked;
            userProfile.noConditions = document.getElementById('no-conditions').checked;
            
            userProfile.medications = [];
            if (!userProfile.noMedications) {
                medicationsData.forEach(med => {
                    const checkbox = document.getElementById(`med-${med.id}`);
                    if (checkbox && checkbox.checked) {
                        userProfile.medications.push(med.id);
                    }
                });
            }
            
            userProfile.conditions = [];
            if (!userProfile.noConditions) {
                conditionsData.forEach(cond => {
                    const checkbox = document.getElementById(`cond-${cond.id}`);
                    if (checkbox && checkbox.checked) {
                        userProfile.conditions.push(cond.id);
                    }
                });
            }

            const errors = validateProfileData();
            if (errors.length > 0) {
                alert('Errores en el perfil:\n\n' + errors.join('\n'));
                return;
            }
            
            localStorage.setItem('parkinpt_profile', JSON.stringify(userProfile));
            updateSessionDisplay();
            updateProfileCompletion();
            alert('Perfil guardado correctamente');
        }

        function loadUserProfile() {
            const savedProfile = localStorage.getItem('parkinpt_profile');
            if (savedProfile) {
                userProfile = JSON.parse(savedProfile);
                
                document.getElementById('profile-name').value = userProfile.name || '';
                document.getElementById('profile-birthdate').value = userProfile.birthdate || '';
                document.getElementById('profile-sex').value = userProfile.sex || '';
                document.getElementById('profile-family-history').value = userProfile.familyHistory || '';
                document.getElementById('other-medications').value = userProfile.otherMedications || '';
                document.getElementById('other-conditions').value = userProfile.otherConditions || '';
                document.getElementById('profile-notes').value = userProfile.notes || '';
                
                // NUEVO: Cargar las opciones "Ninguno"
                if (userProfile.noMedications !== undefined) {
                    document.getElementById('no-medications').checked = userProfile.noMedications;
                    // Disparar el evento change para actualizar la UI
                    document.getElementById('no-medications').dispatchEvent(new Event('change'));
                }
                
                if (userProfile.noConditions !== undefined) {
                    document.getElementById('no-conditions').checked = userProfile.noConditions;
                    // Disparar el evento change para actualizar la UI
                    document.getElementById('no-conditions').dispatchEvent(new Event('change'));
                }
                
                // Solo cargar medicamentos/condiciones si no están deshabilitados por "Ninguno"
                if (!userProfile.noMedications) {
                    userProfile.medications.forEach(medId => {
                        const checkbox = document.getElementById(`med-${medId}`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
                
                if (!userProfile.noConditions) {
                    userProfile.conditions.forEach(condId => {
                        const checkbox = document.getElementById(`cond-${condId}`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
                
                updateSessionDisplay();
            }
        }

        // ... (el resto de las funciones se mantienen igual) ...
    </script>
</body>
</html>
